
2º Modulo de implementação de serviços 

Serviço DNS
Servicos de centralização de informações openldap 
Servidor de Email

Maquina gatewal - firewall, dhcp, proxy, vpn 

intranet - (dns master, apache 2)


DNS 

Principal objetivo e fazer a resolução de nomes
53/udp - consulta
cache - tem alguma resposta referente a requisição 
root-servers - São servidores dispoiveis de dns
ttl - determina por quanto tempo essa consulta vai ficar guardada detro do cache 20m 
o servidor dns determina 
Consulta recursiva - root-servers

-------------------------------------------------------------------------------------

instalação do bind9

apt install bind9 bind9utils dnsutils -y

isola o serviço dns - a camada de serviço evita alguns ataques de exploração, ganhar privilegios de escala isolar ele dentro de um diretorio especifico.

criar o diretorio - mkdir -pv /var/bind9/chroot
vim /etc/default/named - aponta para o serviço do dns para pegar as informações no diretorio 

dentro do arquivo alterar - -t /var/bind9/chroot

quando acontecer o problema de arquivo alterado - rm /etc/default/.named.swp

criando outros diretorios - mkdir -pv /var/bind9/chroot/{etc,dev,var/cache/bind,var/run/named}

-p - parents diretorio pai e filho 

shift + control + v para colar 

ls -l /etc/bind/*

named.conf - arquivo de configuração

Movendo o diretório bind para o chroot - mv /etc/bind /var/bind9/chroot/etc/

ln -s /var/bind9/chroot/etc/bind /etc/bind - criando um link para facilitar o acesso

cd /var/bind9/chroot/dev - 

criar dois dispositivos - null e random 
mknod - criar um dispositivo que vao ser utilizados pelo dns 
mknod null c 1 3 
mknod random c 1 8 




alterar a data - date 030810322023
timedatectl - 
ls -l /etc/localtime 

----------------------------------------------------------------------------

alterar a permissão chmod 660 /var/bind9/chroot/dev/*
id bind - ele sobe com essa essa conta quando o serviço do dns sobe 
chown bind:bind /var/bind9/chroot/etc/bind/rndc.key  /var/bind9/chroot/var/ -R - alterar o dono e grupo 
chmod 775 /var/bind9/chroot/var/ -R alterando a permissão da pasta 
cd /etc/init.d - tem alguns arquivos de serviços 
vim named
PIDFILE=/var/bind9/chroot/var/run/named/named/named.pif
systemctl status bind9
                 named 
tail -f /var/log/messages - arquivo de log 

vim /etc/apparmor.d/usr.sbin.named - configurar o appamor para que ele não bloqueie a permissaõ 

adiciona /var/bind9/chroot/etc/bind/** r,
/var/bind9/chroot/var/** rw,
/var/bind9/chroot/dev/** rw,

para colar e control + shift + v 

systemctl restart apparmor - reiniciar o serviço para concluir a configuração 

journalctl -xe 

named.conf chamado outros arquivos zone, local, options 

include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";

tsig-keygen TRANSFER > tsig.key - criando a chave entre as maquinas para estabelecer a relação de confiança
debian 10 utiliza o md5 agora no 11 o sha para algoritimo 

dentro do arquivo colocar a instrução 

server 192.168.1.20 {
	keys {TRANSFER; };
};

scp -P 52020 tsig.key analista@192.168.1.20:/tmp/ - copiando o arquivo para a maquina datacenter 

mv /tmp/tsig.key /etc/bind/

vim /etc/bind/named.conf

git clone https://github.com/rogerramossilva/linuxforce

-------------------------------------------------------------------------------------------------

copiar estes arquivos intranet 
cp /root/linuxforce/intranet/bind_chroot/etc/bind/named.conf.* /etc/bind/

cp /root/linuxforce/intranet/bind_chroot/bind/* /var/bind9/chroot/var/cache/bind/ -v

chattr -i /etc/resolv.conf
lsattr /etc/resolv.conf

copia dos arquivos na maquina datacenter 
cp /root/linuxforce/datacenter/bind_chroot/etc/bind/named.conf.* /etc/bind/ -v

intranet 

vim /etc/bind/name.conf.options

/var/cache/bind - qual é o diretório que sera usado para armqzenadmento de arquivos de zona 
arquivos de zona mostram quais os dominios que dns local será reponsavel 
/var/bind9/chroot 

version - mostra qual e a versão do dns, porem não mostra a versão 
dnsssec-enable - analise de seguranca, verifica se um dominio e verdadeiro ou não.
allow-query - quem pode utilizar o dns para consultas
allow-recursion - permite a autorização para consultas recursivas para root-servers 
allow-transfer - so e permitida para que tem a chave transfer key TRANSFER 
notify yes - emitir notificação para o slave 
forwarders - 8.8.8.8
listen-on-v6 - suporta ipv6

Poucas mudandas no arquivo na datacenter pois não emitira notificação e trasnferencia tambem não pois ja e a slave


vim /etc/bind/name.conf.default-zone

root.hints - qual e relação dos root-servers 

cat /usr/share/dns/root.hints - mostra os nameservers 

; OPERATED BY VERISIGN, INC.
;
.                        3600000      NS    J.ROOT-SERVERS.NET.
J.ROOT-SERVERS.NET.      3600000      A     192.58.128.30
J.ROOT-SERVERS.NET.      3600000      AAAA  2001:503:c27::2:30


cp -p /usr/share/dns/root.hints /var/bind9/chroot/var/cache/bind/ 

named-checkconf 
/etc/bind/.named.conf.options.swp

-------------------------------------------------------------------------------------------------

arquivo zones o nome da zona e ponto para acessar os root servers 

named.local - arquivo que fas as tratativas de um novo dominio 


cliente Interno www.asf.com 192.168.1.50


cliente externo www.asf.com 200.50.100.50

ferramenta rndc 

acl rede interna e rede externa
view interna e externa 

math-clientes {redeexterna} rede 200.50.100.
type master - qual dominio que eu estou sendo responsavel 
file db.asf.externa - onde eu vou sinaliza quando uma consulta vim da rede externa para acesso a rede interna

zona reversa - passa o endereço ip e tenta descobri qual e o nome que esta vinculado 

100.50.200.in-addr.arpa
200.50.100.    (50)
50   ->  www.asf.com

Externa db.asf.externa rev.asf.externa
Interna db.asf.interna rev.asf.interna

Registro do tipo A aponta o ip versão 4
CNAME - nome 

Quem são os servidores do dominio NS - Nameserver
MX - Mail Exchange - quem e o servidor de email dominio asf.com

dig +short @8.8.8.8 gmail.com mx - tras os servidores de email e sua prioridade

toda zona dns tem pelo menos um SOA - tem algumas informações de espelhamento com o slave e master 
como serial 

TTL - 7200 periodo que fica salvo no cache
YYYYMMDDHH


dig +short www.asf.com
dig +short gateway.asf.com


named-checkzone asf.com db.asf.interna

dig +short asf.com ns
dig +short asf.com mx
dig +short asf.com soa
dig +short gateway.asf.com

/var/bind9/chroot/var/cache/bind - onde estão os arquivos de zona 

-----------------------------------------------------------------------------

arquivo rev.as.interna

reverse a passagem do endereço ip e o retorno do nome 

PTR - tras um apontamento do endereço ip por um nomo ele tras a ultima parte do endereço 
ponteiro ip 10  - intranet ele esta na zona 

SOA - informação qual o dns principal que e reposndsavel 

no registro do reverse voçe usa ptr 

dig +short -x 192.168.1.10 para testar se deu certo o reverse usa o parametro mais -x

200.50.100.10 e 200.50.100.20 - estão fixados na maquina gateway 

200.50.100.100 - cliente externo 

maquina gatewal ssh -p 52001 analista@192.168.1.1

vim /sbin/firewal.sh 
-i - input 
-s - source ip de origem 
-d - destino 

NAT Seesion 
DNAT - mudança de de destino $IJNT:53 variavel de ambiente que aponto para o 192.168.1.10:53 na porta 53

asf.com -> 200.50.100.10

SPF - sender policy framwork - qual ip versão 4 esta autorizado externamente para atender o dns

toda saida da maquina gatewal tem que fazer uma regra para poder enviar resquições a servidores OUTPUT 
--sport 53
-s ip de origem

output - tudo que sai da maquina gatewal 
input - tudo que entra na sua maquina gatewal 
foward - tudo que são transitorias que passa pela maquina gatewal  

para executar as alterações feitas no firewal executa o sh  

ping -c 2 200.50.100.10


dig +short -x 200.50.100.10
dig +short 200.50.100.10
dig +short www.asf.com

-----------------------------------------------------------------------------------------
ldap - base de dados ldap - cadasto de usuario e grupos 
onde os usuarios de comum acesso eles vão estar dentro do ldap 
onde os usuarios e grupos a estrutra vai ser criada dc = asf, dc=com
ou - usuarios - unidade organizacional 

uid=rogerio 
cn=rogerio 

apt install slapd ldap-utils -y    - instalação do ldap 

systemctl enable slapd - colocar na inicialização do sistema 
systemctl is-enabled slapd - verificar se esta habilitado 
systemctl stop slapd - para o serviço

ldap.conf - arquivo de configuração do cliente ldap 
salsl-atutenticação 

pasta schema - e o que vai permitir que vc tenha os campos necessarios para ter a estrutura 

core.schema - e um dos principais que vai ser usado.

slapd.d - e usado para indexação depois que ele faz a leitura da base dados captura das informações, ele atualiza aqui as informações que foram alteradas 

slapd.conf - principal arquivo de configuração não esta dentro da estrutura 
cd /usr/share/doc/slapd/examples
slapd.conf.gz - e um exemplo de um arquivo de configuração que precizamos 

gzip -k -d /usr/share/doc/slapd/examples/slapd.conf.gz -c > /etc/ldap/slapd.conf - criando o arquivo 
pidfile - onde que vai ficar guardado o numero do processo /var/run/slapd/slapd.pid
argsfile - argumentos que vão ser inicializado com o sistema, usuario padrão e grupo, ja sobe o serviço com esse usuario e grupo /var/run/slapd/slapd.args
loglevel - a configuração do tipo da informação que vai ser carregada 

acessar o manual man 5 slapd.conf

1 - trace algumas chamadas para funções
loglevel 0x1
loglevel trace
loglevel 0x3
loglevel trace packets
logfile <filename>

modulos - back_bdb - banco de dados local 

/var/lib/ldap - o banco de dados vai ficar armazenado 

-------------------------------------------------------------------------------------

mover o slapd.d para o /var/backup 

mv slapd.d /var/backups/

apos cria o diretorio mkdir slapd.d
chown openldap:openldap -R /var/lib/ldap/ /etc/ldap/slapd.d/ - mudar o usuario e grupo ldap etc banco de dados 

1-slaptest -f slapd.conf -F slapd.d/ - testar para ver se esta certo 
/var/lib/ldap/id2entry.bdb) failed: No such fil - faltou um arquivo 

2-reiniciar systemctl restart slapd - para gerar o arquivo 

3-chown openldap:openldap -R /var/lib/ldap/ /etc/ldap/slapd.d/

4-slaptest -f slapd.conf -F slapd.d/

root@datacenter:/etc/ldap# slaptest -f slapd.conf -F slapd.d/
641265fd slapd.conf: line 102: rootdn is always granted unlimited privileges.
641265fd slapd.conf: line 119: rootdn is always granted unlimited privileges.
config file testing succeeded

slapcat - vai fazer uma leitura da base de dados e vai trazer os registros as informaçoes previamente cadastradas porem não tem nenhuma informação cadastrada

Cadastrar usuarios e grupos local, depois gerar um script ele vai gerar um arquivo de importação, dai vari dentro da linha de comando dentro do ldap e fazer a importação

1 - criar usuraios e grupos locais
2 - gerar o ldif
3 - importar o ldif 

1 - root@datacenter:/etc/ldap# groupadd -g 5000 g_ti 
root@datacenter:/etc/ldap# groupadd -g 5001 g_diretoria 
root@datacenter:/etc/ldap# groupadd -g 5002 g_suporte 
useradd -m -k /etc/skel/ -s /bin/bash -u 5000 -g g_ti -G g_diretoria,g_suporte kamila
useradd -m -k /etc/skel/ -s /bin/bash -u 5001 -g g_ti -G g_diretoria,g_suporte rafaela
useradd -m -k /etc/skel/ -s /bin/sh -u 5002 -g g_ti -G g_diretoria,g_suporte sophia

passwd kamila
passwd rafela 
passwd sophia

apt install migrationtools -y - conjunto de scripts 
cd /usr/share/migrationtools

apt install file - da para ver o tipo do arquivo 
file *

migrations_common.ph
migration_base.pl
migration_passwd.pl
migration_group.pl 

vim migrate_common.ph

linha 71 configuração 
linha 74
a partir da linha 85

vim migration_base.pl

require '/usr/share/migrationtools/migrate_common.ph'

./migrate_base.pl > /etc/ldap/base.ldif - ele cria as unidade organizacionais 

vim migrate_group.pl

./migrate_group.pl /etc/group /etc/ldap/groups.ldif

vim migrate_passwd.pl

./migrate_passwd.pl /etc/passwd /etc/ldap/users.ldif

cd /etc/ldap	
ls -l *.ldif

realizar o processo de importação 

ldapadd -x -D cn=admin,dc=asf,dc=com -f base.ldif -W - comando utilizado para fazer a importação desse arquivo 

-x = autenticação simples
-D = informa qual o usuario que tem permissão para isso, credenciais do usuario admin
-f = qual o arquivo
-W - pedir a senha do usuario.

root@datacenter:/etc/ldap# ldapadd -x -D cn=admin,dc=asf,dc=com -f base.ldif -W 
Enter LDAP Password: 
adding new entry "dc=asf,dc=com"

adding new entry "ou=Rpc,dc=asf,dc=com"

adding new entry "ou=People,dc=asf,dc=com"

adding new entry "ou=Hosts,dc=asf,dc=com"

adding new entry "nisMapName=netgroup.byuser,dc=asf,dc=com"

adding new entry "ou=Netgroup,dc=asf,dc=com"

adding new entry "ou=Mounts,dc=asf,dc=com"

adding new entry "ou=Aliases,dc=asf,dc=com"

adding new entry "ou=Services,dc=asf,dc=com"

adding new entry "ou=Group,dc=asf,dc=com"

adding new entry "ou=Networks,dc=asf,dc=com"

adding new entry "nisMapName=netgroup.byhost,dc=asf,dc=com"

adding new entry "ou=Protocols,dc=asf,dc=com"


ldapadd -x -D cn=admin,dc=asf,dc=com -f groups.ldif -W - importação dos grupos

root@datacenter:/etc/ldap# ldapadd -x -D cn=admin,dc=asf,dc=com -f groups.ldif -W 
Enter LDAP Password: 
adding new entry "cn=g_ti,ou=Group,dc=asf,dc=com"

adding new entry "cn=g_diretoria,ou=Group,dc=asf,dc=com"

adding new entry "cn=g_suporte,ou=Group,dc=asf,dc=com"


ldapadd -x -D cn=admin,dc=asf,dc=com -f users.ldif -W - importar os usuarios

root@datacenter:/etc/ldap# ldapadd -x -D cn=admin,dc=asf,dc=com -f users.ldif -W 
Enter LDAP Password: 
adding new entry "uid=kamila,ou=People,dc=asf,dc=com"

adding new entry "uid=rafaela,ou=People,dc=asf,dc=com"

adding new entry "uid=sophia,ou=People,dc=asf,dc=com"


slapcat - mostra as atualização da base dados

root@datacenter:/etc/ldap# slapcat 
dn: dc=asf,dc=com
dc: asf
objectClass: top
objectClass: domain
structuralObjectClass: domain
entryUUID: ec7e1b4a-5911-103d-933d-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.135351Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Rpc,dc=asf,dc=com
ou: Rpc
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec8122ea-5911-103d-933e-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.155202Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=People,dc=asf,dc=com
ou: People
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec8292ba-5911-103d-933f-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.164624Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Hosts,dc=asf,dc=com
ou: Hosts
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec830cd6-5911-103d-9340-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.167750Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: nisMapName=netgroup.byuser,dc=asf,dc=com
nisMapName: netgroup.byuser
objectClass: top
objectClass: nisMap
structuralObjectClass: nisMap
entryUUID: ec8397d2-5911-103d-9341-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.171307Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Netgroup,dc=asf,dc=com
ou: Netgroup
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec845c9e-5911-103d-9342-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.176346Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Mounts,dc=asf,dc=com
ou: Mounts
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec84d70a-5911-103d-9343-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.179480Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Aliases,dc=asf,dc=com
ou: Aliases
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec85618e-5911-103d-9344-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.183025Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Services,dc=asf,dc=com
ou: Services
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec863d70-5911-103d-9345-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.188648Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Group,dc=asf,dc=com
ou: Group
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec86cda8-5911-103d-9346-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.192348Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Networks,dc=asf,dc=com
ou: Networks
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec87472e-5911-103d-9347-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.195458Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: nisMapName=netgroup.byhost,dc=asf,dc=com
nisMapName: netgroup.byhost
objectClass: top
objectClass: nisMap
structuralObjectClass: nisMap
entryUUID: ec8840de-5911-103d-9348-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.201847Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: ou=Protocols,dc=asf,dc=com
ou: Protocols
objectClass: top
objectClass: organizationalUnit
structuralObjectClass: organizationalUnit
entryUUID: ec88c022-5911-103d-9349-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131817Z
entryCSN: 20230317131817.205108Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131817Z

dn: cn=g_ti,ou=Group,dc=asf,dc=com
objectClass: posixGroup
objectClass: top
cn: g_ti
userPassword:: e2NyeXB0fXg=
gidNumber: 5000
structuralObjectClass: posixGroup
entryUUID: 26652f56-5912-103d-934a-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131954Z
entryCSN: 20230317131954.279876Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131954Z

dn: cn=g_diretoria,ou=Group,dc=asf,dc=com
objectClass: posixGroup
objectClass: top
cn: g_diretoria
userPassword:: e2NyeXB0fXg=
gidNumber: 5001
memberUid: kamila
memberUid: rafaela
memberUid: sophia
structuralObjectClass: posixGroup
entryUUID: 2666ce24-5912-103d-934b-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131954Z
entryCSN: 20230317131954.290495Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131954Z

dn: cn=g_suporte,ou=Group,dc=asf,dc=com
objectClass: posixGroup
objectClass: top
cn: g_suporte
userPassword:: e2NyeXB0fXg=
gidNumber: 5002
memberUid: kamila
memberUid: rafaela
memberUid: sophia
structuralObjectClass: posixGroup
entryUUID: 26674d04-5912-103d-934c-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317131954Z
entryCSN: 20230317131954.293745Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317131954Z

dn: uid=kamila,ou=People,dc=asf,dc=com
uid: kamila
cn: kamila
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword:: e2NyeXB0fSR5JGo5VCRxV0sxVERxSlVwenJoSEU0OEVhVjMuJEk3bDZjdjFDL
 kpIeEZLL2Y4MndINzltU2lQVVBXYjhxdTI0SWhUWXZBNy4=
shadowLastChange: 19432
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 5000
gidNumber: 5000
homeDirectory: /home/kamila
structuralObjectClass: account
entryUUID: 553a720a-5912-103d-934d-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317132112Z
entryCSN: 20230317132112.852696Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317132112Z

dn: uid=rafaela,ou=People,dc=asf,dc=com
uid: rafaela
cn: rafaela
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword:: e2NyeXB0fSR5JGo5VCRHcmdyNWdtTDU2NmJpeVB5T1o1RjIxJDRNMEViWmp0Q
 nl2VG9GOFU4NUxLT1BZajhSdjNTQmZmU3NlV1RJc3phOC8=
shadowLastChange: 19432
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 5001
gidNumber: 5000
homeDirectory: /home/rafaela
structuralObjectClass: account
entryUUID: 553b770e-5912-103d-934e-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317132112Z
entryCSN: 20230317132112.859376Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317132112Z

dn: uid=sophia,ou=People,dc=asf,dc=com
uid: sophia
cn: sophia
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword:: e2NyeXB0fSR5JGo5VCRzM1UyTDRmcjVIQ0FJdWZrckZsOFowJHI5cTJKb0ZSZ
 09xd0RDajhIbmdURWFUaGF1RjYvQ2ZTVURaYU9VdW1VaEI=
shadowLastChange: 19432
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/sh
uidNumber: 5002
gidNumber: 5000
homeDirectory: /home/sophia
structuralObjectClass: account
entryUUID: 553c631c-5912-103d-934f-e3c0eb115033
creatorsName: cn=admin,dc=asf,dc=com
createTimestamp: 20230317132112Z
entryCSN: 20230317132112.865419Z#000000#000#000000
modifiersName: cn=admin,dc=asf,dc=com
modifyTimestamp: 20230317132112Z


ldapsearch -x -b dc=asf,dc=com uid=sophia -LLL - registro especifico ex de um usuario sophia
-LLL - para não trazer informações desnecessarias 

para criar um outro usuario poderia usar como exemplos o arquivo user.ldif alterar o nome do usuario

alterar o shell dos usuarios no caso sophia estava com /bin/sh 
dn: uid=sophia,ou=People,dc=asf,dc=com

criar um arquivo Shell.ldif
dn: uid=sophia,ou:People,dc=asf,dc=com
changetype: modify - tipo de mudança
replace: loginShell - substituir
loginShell: /bin/bash - 

ldapmodify -x -D cn=admin,dc=asf,dc=com -f shell.ldif -W - fazendo a subsituição da palavra no campo loginShell

root@datacenter:/etc/ldap# ldapmodify -x -D cn=admin,dc=asf,dc=com -f shell.ldif -W
Enter LDAP Password: 
modifying entry "uid=sophia,ou=People,dc=asf,dc=com"

root@datacenter:/etc/ldap# ldapsearch -x -b dc=asf,dc=com uid=sophia -LLL
dn: uid=sophia,ou=People,dc=asf,dc=com
uid: sophia
cn: sophia
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
shadowMax: 99999
shadowWarning: 7
uidNumber: 5002
gidNumber: 5000
homeDirectory: /home/sophia
loginShell: /bin/bash

--------------------------------------------------------------------------------------------------------

fazer um backup das configuraçoes
systemctl stop slapd - para o serviço do slapd 

backup 
remoção 
restore 

slapcat -l /var/backups/bkpldap.ldif
-l paramentro usado para que o processo seja feito 

systemctl start slapd - inciar o serviço novamente

fazer o restore 

ldapdelete -x -D cn=admin,dc=asf,dc=com -r dc=asf,dc=com -W - fazer a remocão da base 
-r - remover 

systemctl stop slapd- para o serviço 

slapadd -cl /var/backups/bkpldap.ldif 
-c - ignorar os erros
 l - apontar o arquivo ldif

systemctl start slapd - inicia novamente 
ldapsearch -x -b dc=asf,dc=com uid=sophia -LLL - testar para ver se encontra o registro do usuario 

implementação da parte grafica para gerenciar 

pacotes 

- precisa do servidor web apache
- programa - ladpacountmaneger
- configuração interna 

apt -y install apache2 php php-cgi libapache2-mod-php php-mbstring php-common php-pear - instação dos pacotes 

apt install ldap-account-manager -y

cd /etc/apache2/conf-available/ - entrar nesse diretorio 

vim ldap-account-manager.conf

http://localhost/lam/templates/login.php - acessar o sistema 
apos vai em lam-configuration
edit servers
acesse com a senha lam

ServerAddres: ldap://192.168.1.20:389

Tree suffix =dc=asf,dc=com
List of valid users = cn=admin,dc=asf,dc=com

Sincronização do cliente interno com o ldadp 

dpkg-reconfigure - aparece as perguntas novamente 

pam-auth-update - marcar a opção para criar o diretorio home quando se autenticar 



fsck -f /dev/sda1

--------------------------------------------------------------------------------

MTA- agente responsavel pelo transporte das suas mesagens email, prover um serviço de email

papel de delivery - a recpção das mensagens, ant spam  MDA mail delivery agent 

Mua - leitura de email, interface para o usuario ex thunderbird 
smtp(25)
smtps(465.87) 

MAA - POP3 IMAP pega as mensagens e tras para o usuario para dentro do MUA
IMAP - mantem uma copia da mensagem no servidor  

MTA(postfix) + MAA(devocot)+MUA(Mozilla Thunderbird)

apt install postfix procmail bsd-mailx -y

systemctl status postfix 

smtps(25,465,587)
POP3(110,995)
IMAPs(143,993)
vim /etc/services

serviço dovecot-core 

apt install dovecot-core dovecot-pop3d dovecot-imapd -y

cd /etc/dovecot



dovecot.conf arquivo principal de configuração mais tem outras configuração em outros arquivos
vim dovecot.conf 

na linha 30 tira o comentario  quais os endereços ips que vai estar vinculado 

cd conf.d

vim 10.auth.conf

vim 10-mail.conf - caminho da mial mailbox vai indicar para o POP e IMAP o caminho da mailbox - onde esta as mensagenss~

vim 10.master.conf - tras uma especificação para o serviço mta 

na linha 106 adiona o usuario e o grupo 

reinciar o serviço do dovect para aplicar a configuração nos arquivos

ss -ntpl |grep "dovect"

apos isso ele habilitou as outras portas e configuradas 995, 143 

cd /etc/postfix/ 

main.cf 
master.cf- arquivos principais de configuração 
vim master.cf

submission - habilita porta 587 smtps
smtps - hablita a 465

systemctl restart postfix 

vim nslcd.conf - erro para reconfigurar alterado o arquivo direto 

----------------------------------------------------------------------------------------

configuração do postifix

cd /etc/postfix

vim main.cf

postconf - atributo - valor

man 5 postconf

postconf -e "parameter=value" ... - tem duas formas de alterar o arquivo main.conf 

entrando no arquivo main.conf ou postconf -e 

uma forma de fazer a declaração por linha de comando = postconf -e myorigin=asf.com

copiar este aqruivo de configuração para o /etc/postfix - cp /root/linuxforce/datacenter/postfix/etc/postfix/main.cf /etc/postfix/

vim main.cf

smtpd_banner MTA ASF CYbersecurity- o usuario que estiver fazendo a conexão vai aparecer esse texto 

append_dit_mydomain = yes - auto completa com o dominio do email quando digitar o usuario 

inserir uma nova linha com mydomain = asf.com

myorigin = asf.com mesma configuração 

myhostname = datacenter.asf.com - não tem a necessidade de ser esse nome - ele tras esse nome 
vai no cabecalho do email 

alias ela e do tipo hash - ele e um texto compilado e gera um codigo não legivel, acessar de forma mais rapido a informação 

para vc forma o hash vai tem que ter em texto o alias

tail -f /var/log/mail.log
vim /etc/aliases

criar um aliases

rh: kamila@asf.com - todo email que chegar no rh vai para kamila
ti: rafaela@asf.com	

name: value1, value2, - chegar para dois emails especificos 

postalias /etc/aliases - apos roda o arquivo para compilar 

ls -l /etc/aliases*

cat /etc/hosts |mail -s "Teste 01 - Aliases" ti@asf.com - mandar um email 

root@datacenter:/etc/postfix# mailq
Mail queue is empty
root@datacenter:/etc/postfix# postqueue -p  -   para ver se tem mensagens na fila que não foram enviadas 
Mail queue is empty
root@datacenter:/etc/postfix# 

vim main.cf

mudestionation - quais são os destinos confiaveis 

smpt.asf.com, pop.asf.com, imp.asf.com

quando estiver configurando o mua esses dois serviços 

relayhost - criar um servidor confiavel para ele trasmitir o email depois

mynetworks - quais as redes ou endereços ips que ele esta autorizando esse servidor para envio de mensagem
127.0.0.0/8 192.168.1.0/24 - vai conseguir utilizar o servidor de email

analista@debian:~$ telnet 192.168.1.20 25
Trying 192.168.1.20...
Connected to 192.168.1.20.
Escape character is '^]'.
220 MTA ASF Cybersecurity

consultar para ver se esta conectando ao servidor 220 - testes ok 

helo mail
250 datacenter.asf.com - identificação da maquina 

mail from: root@asf.com - remetente - origem 
250 2.1.0 Ok - se o codigo for 4 ou 5 e sinal de erro 

rcpt to: rh@asf.com - destino 
250 2.1.5 Ok
~

data - mensagem 
354 End data with <CR><LF>.<CR><LF>
subject: Teste 02 - Telnet cliente interno - titulo 

Testando conexão via cliente interno 
					- corpo da mensagem 
.
250 2.0.0 Ok: queued as 07FBF602D8 - gerou o hash 

quit
221 2.0.0 Bye
Connection closed by foreign host.
analista@debian:~$ 

autentição (sasl) e encriptação(tls)

permit_sals_autheticaçao , permit_mynetworks 


tls - encriptação 

vir presizar de uma chave ou certificado 
certificado .crt 
.key e a chave do certificado

CA - autoridade certificadora que ira validar o cerficado 

mailbox_size_limit - tomanho da sua caixa local caixa postal  
message_size_limit - tamanho da sua mensagem 100000 - 10 mb 

inet_interfaces - all - todas as placa de rede

/home/sophia/Maildir - ele cria essa pasta com os dados dos emails

disable_vrfy_command = ele não permite a busca das contas de email 

apt install maildrop -y

criando esses diretorios 

root@datacenter:/etc/skel# maildirmake Maildir
root@datacenter:/etc/skel# maildirmake Maildir/.Enviados
root@datacenter:/etc/skel# maildirmake Maildir/.Rascunhos
root@datacenter:/etc/skel# maildirmake Maildir/.Lixeira
root@datacenter:/etc/skel# maildirmake Maildir/.Spam

/root/linuxforce/datacenter/postfix/mail_user.sh  - criando as pasta Maildir nos usuarios ja criados kamila,sophia,rafaela 

-------------------------------------------------------------------------------

configurar o serviço assl - tem que fazer a autenticação 

apt install libsasl2-2 sasl2-bin libsasl2-modules -y  - instalar os pacotes 
cd /etc/default/

vim saslauthd 


START=yes - ele permite a inicialização automatica desses serviços 
NAME - nome do serviço

mechanisms  = pam - que permite que vc use as mesma autenticações e contas

THREADS = 5 cinco subrocessos que ele estarta para atender as requisiçoes 

Options = armazena alguns objetos na autenticaçaõ   

mkdir -pv /var/spool/postfix/var/run/saslauthd - criando as pastas

cp /root/linuxforce/datacenter/postfix/etc/sasl/smtpd.conf /etc/postfix/sasl/ - copiar este arquivo 

root@datacenter:/etc/default# cat /etc/postfix/sasl/smtpd.conf 
pwcheck_method: saslauthd - metodo de atenticação saslauthd
mech_list: plain login    

adduser postfix sasl - integrando o usuario postfix no grupo sasl

systemctl restart saslauthd 
systemctl enable saslauthd  - habilitando na inicialização 

configuração do sasl pronta 

camanda de encriotação para tornar mais segura 

mkdir -pv /etc/postfix/ssl

openssl genrsa -out webmail.key 1024 - geraçaõ da chave
genrsa - inclui o algoritmo ja junto 

openssl req -new -key webmail.key -out webmail.csr - criação do certificado 

Country Name (2 letter code) [AU]:BR
State or Province Name (full name) [Some-State]:SAO PAULO
Locality Name (eg, city) []:SAO PAULO
Organization Name (eg, company) [Internet Widgits Pty Ltd]:ASF
Organizational Unit Name (eg, section) []:TI
Common Name (e.g. server FQDN or YOUR name) []:mail.asf.com
Email Address []:analista@asf.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

Assinatura do certificado 

openssl x509 -req -days 365 -in webmail.csr -signkey webmail.key -out webmail.crt

-in - arquivo de entrada 

webmail.crt - arquivo ja assinado 

geração da CA - autoridade certificadora 

openssl req -new -x509 -extensions v3_ca -keyout cakey.pem -out cacert.pem -days 365
Generating a RSA private key
...........................................................+++++
...........................................................+++++
writing new private key to 'cakey.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:BR
State or Province Name (full name) [Some-State]:SAO PAULO
Locality Name (eg, city) []:SAO PAULO
Organization Name (eg, company) [Internet Widgits Pty Ltd]:ASF
Organizational Unit Name (eg, section) []:TI
Common Name (e.g. server FQDN or YOUR name) []:mail.asf.com
Email Address []:analista@asf.com


systemctl restart postfix dovecot saslauthd

ping -c 2 mail.asf.com - testes dns

chown -R sophia.g_ti /home/sophia/ - alterando o grupo da usuaria sophia
 
-----------------------------------------------------------------------------
Nos temos um cenerario que tem maquinas interna 192.168.1. que fazem servidores 
Intranet - DNS master 
Datacenter - DNS Slave, ldap, serviço de email dovecot,postifix  

na maquina gatewal editar o arquivo /sbin/firewal.sh 

-p tcp -d - destino 

-s origem 

firewal.sh 

chattr -i /etc/resolv.conf

na maquina cliente externo, alterar o arquivo /etc/resolv.conf
 mudar o dns da google para o ultimo
configurar o thunderbird

----------------------------------------------------------------------

Servidor web 

vamos ver o apache e ndix 

debian - apache2
centos: httpd 

servidor tem nomes direfentes nas versões do linux 

1 - apt install apache2 -y

- modulos
- arquivos de configuração 
- site 

http://express.asf.com/ - ooodefault - usado para fazer testes para ver se esta funcionado o seviço.

o dns fas a resoluçaõ de nomes express - para 192.168.1.10

cd /etc/apache2/ 

vim apache2.conf - principal arquivo de confifuração e o apache2.conf 

dentro do conf-enable vai estar o arquivo security.conf
mods-anable - modulos que estão habilitados

arquivos ports altera a porta 

mods-enable, conf-enable e sites-enable - estrutura de diretorios 

mods-available
mods-enabled
conf-avaiable
conf-enabled
sites-available
sites-enabled

todos os arquivos novos de configutação ficam nos avalible 

Modulos
-a2enmod(habilitar)
-a2idsmod(desabilitar)

configuração 
a2enconf
a2disconf

site
a2ensite
a2dissite

/etc/apache2/envvars

error.log - guarda warning 
apachectl -t - configurar a sintaxe 

a2disconf security - desabilitar esse modulo 
a2enconf security - abilita o modulo
ls -l /var/log/apache2 - todos os logs vão ficar dentro desse diretorio 

intalar o php e complementos para subir uma pagina 

apt install php php7.4-curl php7.4-gd php7.4-intl php7.4-xmlrpc php7.4-mysql -y

php -v - ver a versão 

root@intranet:/etc/apache2/mods-enabled# ls | grep php
php7.4.conf
php7.4.load

systemctl restart apache2

cd /srv/www
apt install unzip - vamos prescizar extrair um arquivo 
unzip /root/linuxforce/intranet/express.zip
chown www-data:www-data -R /srv/www/express/ - mudar o dono do usuario e grupo 
editar um arquivo para que o site possa subir de sites-available para /srv/www
 
--------------------------------------------------------------------------------------------------
´
cd /etc/apache/sites-available

vim express.conf

VirutalHost - controle especifico sobre as paginas web

apachectl -t - Verificar a sintaxe 

systemctl restart apache2

a2ensite express.conf - habilita o site

systemctl reload apache2

entrar no site express.asf.com

mkdir -pv /etc/ssl/express - vai ser gerado aqui os certificados aumentando o nivel de seguranca 

a2enmod ssl - habilitar esse modulo 
a2enmod rewrite

criar o ceritificado 

1 - chave 
2 - requisição do certificado 
3 - assinatura 


openssl genrsa -out express.key 2048 - gera a chave 

root@intranet:/etc/apache2/sites-available# openssl req -new -key express.key -out express.csr - criando o certificado 

You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:BR
State or Province Name (full name) [Some-State]:SAO PAULO
Locality Name (eg, city) []:SAO PAULO
Organization Name (eg, company) [Internet Widgits Pty Ltd]:ASF
Organizational Unit Name (eg, section) []:TI
Common Name (e.g. server FQDN or YOUR name) []:express.asf.com
Email Address []:analista@asf.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

openssl x509 -req -days 365 -in express.csr -signkey express.key -out express.crt - assinatura 

SSLEngine On - halita para acesso pela porta 443

apachectl -t

instalação do banco de dados mariaDB
tabela: log
usuario: express
senha: AllSafe0!
banco: backup

na maquina datacenter instalar o banco 

apt install mariadb-server -y

mariadb-secure-installation - maior seguranca 

mysql -u root -p - conectar no banco de dados 

show databases; - mostra as bases de dados

create database backup; - criando a base de dados backup 
use backup
show tables;
source /root/linuxforce/datacenter/mysql/backup.sql; - cria as tabelas 

-------------------------------------------------------------------------------------------------

Login: express
senha: AllSafe!

mudar este usuario 
select user from mysql.user; - ver quais sao os usuarios criados 

grant all privileges on backup.* to express@'%' identified by 'AllSafe0!'; - dando as permissoes para o usuario express

show grants for express@'%'; - ver quais as permissões que o usuario tem 

flush privileges; - aplicar as alterações 

ntpl |grep mariadb 

vim /etc/mysql/mariadb.conf.d/50-server.cnf - entrar no arquivo e alterar o endereço ip mudar de 127.0.0.0 ou comentar a linha para que a rede possa acessar 

systemctl restart mariadb

LAMP: 

L - Linux
A - Apache
M - mariadb
P - PHP

/etc/apache2/sites-available

vim express.conf

apachectl -t

htpasswd -c -m /etc/apache2/.express rodrigo - criando usuarios 
htpasswd -m /etc/apache2/.express tereza

cat /etc/apache2/.express

systemctl restart apache2

apt install libapache2-mod-authnz-pam - modulo do apache, suporte autenticação suportada via pam 

vim /etc/pam.d/apache2 - criar este arquivo 

o pam trabalha com quatro gerenciadores ele cuida do processo de autenticação, autorização, troca de senha e de seções 


apt install libapache2-mod-authnz-external pwauth 

mkdir /srv/www/express/downloads

cp /etc/*.conf  /srv/www/express/downloads/

a2enmod authnz_ldap - habilitar o modulo 





